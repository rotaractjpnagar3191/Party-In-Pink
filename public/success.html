<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Success · Party In Pink</title>
  <meta name="theme-color" content="#E91E63" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=20251120-004" />
</head>
<body class="theme-pip">
  <div id="app-preloader" aria-hidden="true"><div class="spinner"></div></div>

  <header class="site-header">
    <div class="wrap">
      <a class="brand" href="index.html">
        <img src="assets/logos/PiP_Black.png" alt="Party In Pink Logo" onerror="this.style.display='none'">
      </a>
      <nav class="main-nav" aria-label="Primary">
        <a href="about.html">About Us</a>
        <a href="register.html">Single Registration</a>
        <a href="bulk.html">Bulk Registration</a>
        <a href="donate.html" class="btn btn-primary btn-sm">Donate</a>
      </nav>
      <button id="navToggle" class="nav-toggle" aria-label="Toggle Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <main class="section">
    <div class="wrap">
      <div class="card success-card center" id="successStatus">
        <div class="checkmark">✓</div>
        <h1 id="thanksLine">Thank you!</h1>
        <p id="successMsg" class="muted"></p>
        <div id="statusBadge" style="margin-top: 10px; font-weight: 600; color: var(--primary);"></div>
        <div id="statusDetail" class="muted tiny" style="margin-top: 5px;"></div>

        <div id="orderIdBox" style="margin-top: 2rem; padding: 1rem; background: rgba(233, 30, 99, 0.1); border-left: 3px solid #E91E63; border-radius: 8px; display: none;">
          <strong style="color: #E91E63; display: block; margin-bottom: 0.5rem;">Order ID:</strong>
          <code id="orderId" style="background: #0F0F12; color: #bbb; padding: 0.5rem; border-radius: 4px; display: inline-block; font-family: monospace; word-break: break-all;"></code>
        </div>

        <div id="nextSteps" style="margin-top: 2rem; padding: 1rem; background: rgba(0, 200, 83, 0.1); border-left: 3px solid #00C853; border-radius: 8px; display: none;">
          <strong style="color: #00C853; display: block; margin-bottom: 0.75rem;">What's Next?</strong>
          <ul style="margin: 0; padding-left: 1.5rem; color: #bbb; line-height: 1.8;">
            <li>Check your email (including spam folder) for ticket confirmation</li>
            <li>You'll receive ticket download links and event details</li>
            <li>Event date: December 14, 2025 at 7:30 AM</li>
            <li><a href="status.html" style="color: #E91E63; text-decoration: none; font-weight: 600;">Check order status anytime →</a></li>
          </ul>
        </div>

        <div class="cta-row mt-lg">
          <a href="index.html" class="btn btn-ghost">Home</a>
          <a href="status.html" class="btn btn-primary">Check Order Status</a>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <div class="footer-cols">
        <div>
          <h4>Party In Pink</h4>
          <p>Rotaract Club of Bangalore JP Nagar</p>
          <p class="muted">© <span id="year"></span> All rights reserved.</p>
        </div>
        <nav>
          <h4>Quick Links</h4>
          <a href="register.html">Single Registration</a>
          <a href="bulk.html">Bulk Registration</a>
          <a href="donate.html">Donate</a>
        </nav>
        <div>
          <h4>Contact</h4>
          <p><a href="mailto:rotaractjpnagar@gmail.com">rotaractjpnagar@gmail.com</a></p>
          <p><a href="https://www.rotaractjpnagar.org/pip" target="_blank" rel="noopener noreferrer">rotaractjpnagar.org/pip</a></p>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // Lightweight fill for title/message (works even if no extra data is present)
    (function () {
      const qs = new URLSearchParams(location.search);
      const type = (qs.get('type') || qs.get('t') || '').toLowerCase();
      const order = qs.get('order') || qs.get('o') || '';
      const email = qs.get('email') || qs.get('e') || localStorage.getItem('pip_last_email') || '';

      const title = document.getElementById('thanksLine');
      const msg = document.getElementById('successMsg');
      const orderBox = document.getElementById('orderIdBox');
      const orderIdEl = document.getElementById('orderId');
      const nextSteps = document.getElementById('nextSteps');

      let headline = 'Thank you!';
      if (type.includes('bulk')) headline = 'Thank you for your bulk registration!';
      else if (type.includes('donation')) headline = 'Thank you for your donation!';
      else if (type.includes('single') || type.includes('registration')) headline = 'Thank you for your registration!';

      title.textContent = headline;
      msg.textContent = email
        ? `All passes have been queued for delivery to: ${email}`
        : 'All passes have been queued for delivery.';

      // Show order ID
      if (order) {
        orderBox.style.display = 'block';
        orderIdEl.textContent = order;
      }

      // Show next steps
      if (order || email) {
        nextSteps.style.display = 'block';
      }
    })();
  </script>

  <style>
    .loader-overlay.hidden {
      display: none !important;
    }
  </style>

  <!-- SUCCESS PAGE POLLING -->
  <script>
    const qs = new URLSearchParams(location.search);
    const orderId = qs.get('order');

    if (orderId) {
      (async function pollForCompletion() {
        const badge = document.getElementById('statusBadge');
        const detail = document.getElementById('statusDetail');

        // Create overlay with progress
        const ov = document.createElement('div');
        ov.className = 'loader-overlay';
        ov.setAttribute('aria-busy', 'true');
        ov.innerHTML = `
          <div class="card" style="background:#16161A;border:1px solid var(--border);padding:20px;border-radius:14px;min-width:280px;text-align:center">
            <div class="spinner" style="margin:0 auto 10px"></div>
            <div id="issueTitle" style="font-weight:700;margin-bottom:6px">Dispatching passes…</div>
            <div id="issueSub" class="muted tiny">Contacting ticketing partner…</div>
          </div>`;
        document.body.appendChild(ov);

        const issueTitle = ov.querySelector('#issueTitle');
        const issueSub = ov.querySelector('#issueSub');

        let tries = 0;
        let done = false;

        async function checkStatus() {
          if (done) return;
          tries++;

          try {
            const abortController = new AbortController();
            const timeoutId = setTimeout(() => abortController.abort(), 10000);
            
            let r;
            try {
              r = await fetch(`/api/order-status?id=${encodeURIComponent(orderId)}`, {
                cache: 'no-store',
                signal: abortController.signal
              });
            } finally {
              clearTimeout(timeoutId);
            }

            if (r.ok) {
              const resp = await r.json();
              const oc = resp.order || resp;
              
              // Log for debugging
              const fulfillmentStatus = oc?.fulfilled?.status;
              console.log(`[poll-${tries}] fulfilled=${fulfillmentStatus}`);
              
              // Update UI with current status
              if (issueSub) {
                issueSub.textContent = `Attempt ${tries}... fulfilled=${fulfillmentStatus || 'pending'}`;
              }

              // Check completion
              if (fulfillmentStatus === 'ok' || fulfillmentStatus === 'partial') {
                done = true;
                console.log(`[poll] ✓ COMPLETED with status=${fulfillmentStatus}`);
                
                if (badge) badge.textContent = fulfillmentStatus === 'ok' ? '✓ Tickets issued' : '⚠ Partially issued';
                if (detail) {
                  detail.innerHTML = fulfillmentStatus === 'ok'
                    ? `All passes queued for delivery${oc.recipients ? ': ' + oc.recipients.join(', ') : ''}`
                    : 'Some passes could not be issued. We\'ll fix this manually.';
                }
                
                // Remove overlay - try multiple methods to ensure it's gone
                console.log('[poll] Removing overlay...');
                ov.classList.add('hidden');
                ov.setAttribute('aria-busy', 'false');
                setTimeout(() => {
                  ov.parentNode?.removeChild(ov);
                  console.log('[poll] Overlay removed');
                }, 50);
                return;
              }
            }
          } catch (e) {
            console.log(`[poll-${tries}] error: ${e.message}`);
          }

          // Schedule next poll or timeout
          if (tries < 60) { // Poll for up to 2 minutes (60 * 2s)
            if (issueTitle) issueTitle.textContent = `Dispatching passes… (${tries * 2}s)`;
            setTimeout(checkStatus, 2000);
          } else {
            done = true;
            console.log('[poll] TIMEOUT - showing manual message');
            if (badge) badge.textContent = 'Processing...';
            if (detail) detail.textContent = 'Your passes are being prepared. Check your email within a few minutes, or visit the status page.';
            setTimeout(() => {
              ov.setAttribute('aria-busy', 'false');
              ov.remove();
            }, 1000);
          }
        }

        // Start polling
        checkStatus();
      })();
    }
  </script>

  <script src="app.js?v=2025-11-20" defer></script>
</body>
</html>
