<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ops Dashboard — Party In Pink 4.0</title>
  <meta name="theme-color" content="#E91E63" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=20251120-002" />
</head>

<body class="theme-pip page-ops">
  <!-- single global preloader (same as other pages) -->
  <div id="app-preloader" aria-hidden="true">
    <div class="spinner"></div>
  </div>

  <!-- Header (kept identical to index.html) -->
  <header class="site-header">
    <div class="wrap">
      <a class="brand" href="index.html">
        <img src="assets/logos/PiP_Black.png" alt="Party In Pink 4.0 logo">
      </a>

      <nav class="main-nav" aria-label="Primary">
        <a href="about.html">About Us</a>
        <a href="index.html">Home</a>
        <a href="register.html">Register</a>
        <a href="bulk.html">Bulk</a>
        <a href="donate.html">Donate</a>
        <a href="ops.html" class="active">Ops</a>
      </nav>

      <button id="navToggle" class="nav-toggle" aria-label="Toggle Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <main id="main" class="section">
    <div class="wrap">
      <div class="card">
        <div class="card-head"
          style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;">
          <div>
            <h1 style="margin:0">Ops Dashboard</h1>
            <p id="ipline" class="muted tiny" style="margin:.25rem 0 0">Your IP: —</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="adminkey" type="password" placeholder="Admin key" class="input-like" />
            <button class="btn btn-ghost" id="saveKey">Save</button>
            <button class="btn btn-primary" id="refresh">Refresh</button>
          </div>
        </div>

        <p class="muted tiny" style="margin-top:8px">
          Aggregates from GitHub ledger: orders (Cashfree + issuance) and KonfHub webhooks (both events).
        </p>

        <!-- KPI cards -->
        <div class="grid-3" id="kpis" style="margin-top:12px">
          <!-- filled by JS -->
        </div>

        <!-- Recent tables -->
        <div class="grid-2" style="margin-top:18px">
          <div>
            <h3>Recent Orders</h3>
            <table class="table" id="orders">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Passes</th>
                  <th>Email</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div>
            <h3>Recent KonfHub Events</h3>
            <table class="table" id="kh">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Event ID</th>
                  <th>Type</th>
                  <th>Email</th>
                  <th>Ticket</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="wrap footer-cols">
      <div>
        <h4>Party In Pink</h4>
        <p>Rotaract Club of Bangalore JP Nagar</p>
        <p class="muted">© <span id="year"></span> All rights reserved.</p>
      </div>
      <nav>
        <h4>Quick Links</h4>
        <a href="register.html">Single Registration</a>
        <a href="bulk.html">Bulk Registration</a>
        <a href="donate.html">Donate</a>
      </nav>
      <div>
        <h4>Contact</h4>
        <p><a href="mailto:rotaractjpnagar@gmail.com">rotaractjpnagar@gmail.com</a></p>
      </div>
    </div>
  </footer>

  <script>
    // ---- tiny helpers ---------------------------------------------------------
    const $ = s => document.querySelector(s);
    const rupee = v => '₹' + Number(v || 0).toLocaleString('en-IN');
    const pill = s => `<span class="pill-badge ${s}">${s}</span>`;

    // Bootstrap key from URL (?k=) once
    (() => {
      const u = new URL(location.href);
      const k = u.searchParams.get('k');
      if (k) localStorage.setItem('ops_admin_key', k);
    })();

    function loadKey() {
      const k = localStorage.getItem('ops_admin_key') || '';
      const box = document.getElementById('adminkey');
      if (box) box.value = k;
      return k;
    }
    function saveKey() {
      const v = (document.getElementById('adminkey')?.value || '').trim();
      localStorage.setItem('ops_admin_key', v);
      return v;
    }

    // Skeletons while loading
    function showLoading() {
      $('#kpis').innerHTML = `
      <div class="card skeleton h40"></div>
      <div class="card skeleton h40"></div>
      <div class="card skeleton h40"></div>
      <div class="card skeleton h40"></div>
      <div class="card skeleton h40"></div>`;
      $('#orders tbody').innerHTML = '<tr><td colspan="6" class="help">Loading…</td></tr>';
      $('#kh tbody').innerHTML = '<tr><td colspan="5" class="help">Loading…</td></tr>';
    }

    // Accept many server response shapes
    function normalizeStats(raw) {
      const totals = raw.totals || raw.total || {};
      // lists can appear under several names
      const orders =
        raw.recent_orders || raw.orders_recent || raw.orders || raw.items || [];
      const kh =
        raw.recent_konfhub || raw.konfhub_recent || raw.events || raw.webhooks || [];

      return { totals, orders, kh };
    }

    // Tolerant field readers for rows
    function readOrderRow(r) {
      return {
        created: r.created_at || r.created || r.time || r.at || null,
        type: r.type || r.kind || r.category || '—',
        amount: r.amount ?? r.total ?? r.value ?? 0,
        passes: r.passes ?? r.quantity ?? r.qty ?? r.tickets ?? 0,
        email: r.email || r.customer_email || r.buyer?.email || '—',
        status: r.status || r.state || r.result || '—'
      };
    }

    function readKHRow(r) {
      return {
        at: r.at || r.time || r.created_at || null,
        event_id: r.event_id || r.id || r.event || '—',
        type: r.type || r.name || r.event_type || '—',
        email: r.email || r.user_email || '—',
        ticket: r.ticket_id || r.ticket || r.code || '—'
      };
    }

    function renderKPIs(j) {
      const t = j.totals;
      const evItems = Object.entries(t.konfhub_webhooks.by_event || {})
        .map(([id, c]) => `<div class="help"><strong>${id}</strong><br>${c} events</div>`)
        .join("");

      const fmtCur = (v) => '₹' + (Number(v || 0)).toLocaleString('en-IN');

      el('#kpis').innerHTML = `
    <div class="card">
      <div class="help">Tickets (total)</div>
      <div style="font-size:22px;font-weight:700">${t.tickets.total}</div>
      <div class="help">Single: ${t.tickets.single.passes} • Donation: ${t.tickets.donation.passes} • Bulk: ${t.tickets.bulk.passes}</div>
    </div>
    <div class="card">
      <div class="help">Donations</div>
      <div style="font-size:22px;font-weight:700">${t.donations.count}</div>
      <div class="help">${fmtCur(t.donations.amount)} • ${t.donations.passes} passes</div>
    </div>
    <div class="card">
      <div class="help">Bulk</div>
      <div style="font-size:22px;font-weight:700">${t.bulk.count}</div>
      <div class="help">${t.bulk.quantity} planned passes</div>
    </div>
    <div class="card">
      <div class="help">Issuance</div>
      <div class="help">
        <span class="pill-badge ok">ok ${t.issuance.ok}</span>
        &nbsp; <span class="pill-badge partial">partial ${t.issuance.partial}</span>
        &nbsp; <span class="pill-badge failed">failed ${t.issuance.failed}</span>
        &nbsp; <span class="pill-badge pending">pending ${t.issuance.pending}</span>
      </div>
      <div class="help">${t.issuance.passes_issued} passes issued</div>
    </div>
    <div class="card">
      <div class="help">KonfHub webhooks</div>
      <div style="font-size:22px;font-weight:700">${t.konfhub_webhooks.total}</div>
      <div class="help">${evItems || '—'}</div>
    </div>
  `;
    }

    function renderOrders(rows) {
      const tb = $('#orders tbody');
      if (!rows || !rows.length) {
        tb.innerHTML = '<tr><td colspan="6" class="help">No orders yet</td></tr>';
        return;
      }
      tb.innerHTML = rows.map(r => {
        const o = readOrderRow(r);
        return `<tr>
        <td class="help">${o.created ? new Date(o.created).toLocaleString() : '—'}</td>
        <td>${o.type}</td>
        <td>${rupee(o.amount)}</td>
        <td>${o.passes}</td>
        <td class="help">${o.email}</td>
        <td>${pill(o.status)}</td>
      </tr>`;
      }).join('');
    }

    function renderKH(rows) {
      const tb = $('#kh tbody');
      if (!rows || !rows.length) {
        tb.innerHTML = '<tr><td colspan="5" class="help">No KonfHub events yet</td></tr>';
        return;
      }
      tb.innerHTML = rows.map(r => {
        const e = readKHRow(r);
        return `<tr>
        <td class="help">${e.at ? new Date(e.at).toLocaleString() : '—'}</td>
        <td class="help">${e.event_id}</td>
        <td class="help">${e.type}</td>
        <td class="help">${e.email}</td>
        <td class="help">${e.ticket}</td>
      </tr>`;
      }).join('');
    }

    async function fetchStats() {
      const key = loadKey();
      if (!key) {
        $('#kpis').innerHTML = `<div class="card">Enter the admin key and click <strong>Save</strong>.</div>`;
        $('#orders tbody').innerHTML = '';
        $('#kh tbody').innerHTML = '';
        return;
      }

      showLoading();

      let res, text;
      try {
        const q = `?k=${encodeURIComponent(key)}&recent=30`; // ask server for a decent number of rows
        res = await fetch('/.netlify/functions/admin-stats' + q, {
          headers: { 'x-admin-key': key }
        });
        text = await res.text();
      } catch (e) {
        $('#kpis').innerHTML = `<div class="card">Network error: ${e.message}</div>`;
        return;
      }

      let json;
      try { json = JSON.parse(text); } catch { json = { ok: false, error: text || 'Bad JSON' }; }

      if (!res.ok || json.ok === false) {
        const msg = json.error || `HTTP ${res.status}`;
        $('#kpis').innerHTML = `<div class="card">⚠️ ${msg}. Check the admin key or server logs.</div>`;
        $('#orders tbody').innerHTML = '';
        $('#kh tbody').innerHTML = '';
        return;
      }

      const norm = normalizeStats(json);
      renderKPIs(json);
      renderOrders(norm.orders);
      renderKH(norm.kh);
    }

    document.getElementById('saveKey')?.addEventListener('click', () => { saveKey(); fetchStats(); });
    document.getElementById('refresh')?.addEventListener('click', fetchStats);

    loadKey();
    fetchStats();
  </script>


  <!-- global JS (same as site; nav toggle etc.) -->
  <script src="app.js" defer></script>
</body>

</html>